{{- define "harbor.notary-server.config" -}}
{
  "server": {
    "http_addr": ":4443"
  },
  "trust_service": {
    "type": "remote",
    "hostname": "{{ template "harbor.notary-signer" . }}",
    "port": "7899",
{{- if not .Values.notary.secretName }}
    "tls_ca_file": "./notary-signer-ca.crt",
{{- else }}
    "tls_ca_file": "/etc/ssl/notary/cert/notary-signer-ca.crt",
{{- end }}
    "key_algorithm": "ecdsa"
  },
  "logging": {
    "level": "{{ .Values.logLevel }}"
  },
  "storage": {
    "backend": "postgres",
    "db_url": "{{ template "harbor.database.notaryServer" . }}"
  },
  "auth": {
      "type": "token",
      "options": {
          "realm": "{{ .Values.externalURL }}/service/token",
          "service": "harbor-notary",
          "issuer": "harbor-token-issuer",
          "rootcertbundle": "/root.crt"
      }
  }
}
{{- end -}}

{{- define "harbor.notary-signer.config" -}}
{
  "server": {
    "grpc_addr": ":7899",
{{- if not .Values.notary.secretName }}
    "tls_cert_file": "./notary-signer.crt",
    "tls_key_file": "./notary-signer.key"
{{- else }}
    "tls_cert_file": "/etc/ssl/notary/cert/notary-signer.crt",
    "tls_key_file": "/etc/ssl/notary/cert/notary-signer.key"
{{- end }}
  },
  "logging": {
    "level": "{{ .Values.logLevel }}"
  },
  "storage": {
    "backend": "postgres",
    "db_url": "{{ template "harbor.database.notaryServer" . }}",
    "default_alias": "defaultalias"
  }
}
{{- end -}}

{{ if .Values.notary.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ template "harbor.notary-server" . }}
  labels:
{{ include "harbor.labels" . | indent 4 }}
type: Opaque
data:
  SERVER_DB_URL: {{ include "harbor.database.notaryServer" . | b64enc }}
  SIGNER_DB_URL: {{ include "harbor.database.notarySigner" . | b64enc }}
  server-config.postgres.json: {{ include "harbor.notary-server.config" . | b64enc }}
  signer-config.postgres.json: {{ include "harbor.notary-signer.config" . | b64enc }}
{{ end }}
