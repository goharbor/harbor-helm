suite: TrivyStatefulSet

tests:
  - it: PersistenceDisabled
    set:
      persistence:
        enabled: false
        persistentVolumeClaim:
          trivy:
            existingClaim: trivy-data
    template: templates/trivy/trivy-sts.yaml
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 1
      - notExists:
          path: spec.volumeClaimTemplates
      - exists:
          path: spec.template.spec.volumes[0].emptyDir

  - it: PersistenceEnabled
    set:
      persistence:
        enabled: true
    template: templates/trivy/trivy-sts.yaml
    asserts:
      - notExists:
          path: spec.template.spec.volumes
      - lengthEqual:
          path: spec.volumeClaimTemplates
          count: 1

  - it: ExistingClaim
    set:
      persistence:
        enabled: true
        persistentVolumeClaim:
          trivy:
            existingClaim: trivy-data
    template: templates/trivy/trivy-sts.yaml
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 1
      - notExists:
          path: spec.volumeClaimTemplates
      - exists:
          path: spec.template.spec.volumes[0].persistentVolumeClaim
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: trivy-data

  - it: InternalTLSEnabledWithoutPersistence
    set:
      internalTLS:
        enabled: true
      persistence:
        enabled: false
    template: templates/trivy/trivy-sts.yaml
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 2
      - notExists:
          path: spec.volumeClaimTemplates

  - it: InternalTLSEnabledWithPersistence
    set:
      internalTLS:
        enabled: true
      persistence:
        enabled: true
    template: templates/trivy/trivy-sts.yaml
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 1
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 1

  - it: InternalTLSEnabledWithPersistenceExistigClaim
    set:
      internalTLS:
        enabled: true
      persistence:
        enabled: true
        persistentVolumeClaim:
          trivy:
            existingClaim: trivy-data
    template: templates/trivy/trivy-sts.yaml
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 2
      - notExists:
          path: spec.volumeClaimTemplates
  
  - it: TrivyDBRepository
    set:
      trivy:
        enabled: true
    template: templates/trivy/trivy-sts.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[14].value
          value: "mirror.gcr.io/aquasec/trivy-db,ghcr.io/aquasecurity/trivy-db"
      - equal:
          path: spec.template.spec.containers[0].env[14].name
          value: "SCANNER_TRIVY_DB_REPOSITORY"
      - equal:
          path: spec.template.spec.containers[0].env[15].value
          value: "mirror.gcr.io/aquasec/trivy-java-db,ghcr.io/aquasecurity/trivy-java-db"
      - equal:
          path: spec.template.spec.containers[0].env[15].name
          value: "SCANNER_TRIVY_JAVA_DB_REPOSITORY"